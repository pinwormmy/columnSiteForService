<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mall.petshop.mapper.ProductMapper">

	<resultMap type="com.mall.petshop.product.ProductDTO" id="productDTO">
		<result column="PRODUCT_NUM" property="productNum" />
		<result column="NAME" property="name" />
		<result column="PRICE" property="price" />
		<result column="THUMBNAIL" property="thumbnail" />
	</resultMap>

	<resultMap type="com.mall.petshop.product.CartDTO" id="cartDTO">
		<result column="CART_NUM" property="cartNum" />
		<result column="PRODUCT_NUM" property="productNum" />
		<result column="QUANTITY" property="quantity" />
		<result column="ID" property="id" />
		<collection property="productDTO" resultMap="productDTO" />
	</resultMap>

	<resultMap type="com.mall.petshop.product.LikeItDTO" id="likeIt">
		<result column="PRODUCT_NUM" property="productNum" />
		<result column="ID" property="id" />
		<collection property="productDTO" resultMap="productDTO" />
	</resultMap>

	<select id="searchProduct">
		SELECT *
			FROM MEMBER
			WHERE ID=#{id} and PW=#{pw}
	</select>

	<select id="showProductList" resultType="com.mall.petshop.product.ProductDTO">
		SELECT PRODUCT_NUM, SEARCH_TAG, NAME, PRICE, THUMBNAIL, FREE_SHIPPING,
				ON_DISCOUNT, REG_DATE, CONTENT, REVIEW_COUNT
			FROM PRODUCT
			WHERE <include refid="searchKeyword" />
			<include refid="freeShipping" /> <include refid="onDiscount" />
			<include refid="sortOption" />
			LIMIT #{postBeginPoint}, #{displayPostLimit}
	</select>

	<sql id="searchKeyword">
		(SEARCH_TAG like CONCAT('%', #{keyword}, '%') OR
		NAME like CONCAT('%', #{keyword}, '%') OR
		CONTENT like CONCAT('%', #{keyword}, '%'))
	</sql>

	<sql id="sortOption">
		<if test="sortType == 'recent'">
			order by PRODUCT_NUM desc
		</if>
		<if test="sortType == 'lowPrice'">
			order by PRICE ASC
		</if>
		<if test="sortType == 'highPrice'">
			order by PRICE DESC
		</if>
		<if test="sortType == 'bestReview'">
			order by REVIEW_COUNT desc
		</if>
	</sql>

	<sql id="freeShipping">
		<if test="freeShipping == 1">
			AND FREE_SHIPPING=1
		</if>
	</sql>

	<sql id="onDiscount">
		<if test="onDiscount == 1">
			AND ON_DISCOUNT=1
		</if>
	</sql>

	<select id="countTotalPost" resultType="int">
		SELECT COUNT(*) from PRODUCT
			WHERE <include refid="searchKeyword" />
	</select>

	<select id="readProduct" resultType="com.mall.petshop.product.ProductDTO">
		SELECT * FROM PRODUCT
			WHERE PRODUCT_NUM=#{productNum}
	</select>

	<insert id="addProduct">
		INSERT INTO PRODUCT(PRODUCT_NUM, SEARCH_TAG, NAME, PRICE, FREE_SHIPPING, ON_DISCOUNT, REG_DATE, CONTENT, THUMBNAIL)
			VALUES(PRODUCT_SEQ.NEXTVAL, #{searchTag}, #{name}, #{price}, #{freeShipping}, #{onDiscount}, sysdate, #{content}, #{thumbnail})
	</insert>

	<delete id="deleteProduct">
		DELETE PRODUCT
			WHERE PRODUCT_NUM=#{productNum}
	</delete>

	<select id="checkLike" resultType="int">
		SELECT COUNT(*)
			FROM LIKEIT
			WHERE ID=#{id} AND PRODUCT_NUM=#{productNum}
	</select>

	<select id="loadLikeList" resultType="com.mall.petshop.product.LikeItDTO">
		SELECT PRODUCT_NUM FROM LIKEIT
			WHERE ID=#{id}
	</select>

	<insert id="switchToLike">
		INSERT INTO LIKEIT
			VALUES(#{id}, #{productNum})
	</insert>

	<delete id="switchToUnlike">
		DELETE LIKEIT
			WHERE PRODUCT_NUM=#{productNum}
			AND ID=#{id}
	</delete>

	<select id="countTotalReview" resultType="int">
		SELECT count(*) from REVIEW
		WHERE PRODUCT_NUM=#{productNum}
	</select>

	<insert id="addReview">
		INSERT INTO REVIEW(PRODUCT_NUM, REVIEW_NUM, ID, REG_DATE, CONTENT)
			VALUES(#{productNum}, REVIEW_NUM_SEQ.nextval, #{id}, SYSDATE, #{content})
	</insert>

	<select id="showReviewList" resultType="com.mall.petshop.product.ReviewDTO">
		SELECT PRODUCT_NUM, review_NUM, ID, REG_DATE, CONTENT
			FROM REVIEW
			WHERE PRODUCT_NUM=#{productNum}
			ORDER BY REVIEW_NUM DESC
			LIMIT #{postBeginPoint}, #{displayPostLimit}
	</select>

	<delete id="deleteReview">
		DELETE from REVIEW
			WHERE REVIEW_NUM=#{reviewNum}
	</delete>

	<update id="updateReviewCount">
		UPDATE PRODUCT
			SET REVIEW_COUNT=
				(SELECT COUNT(*) FROM REVIEW
					WHERE PRODUCT_NUM=#{productNum})
				WHERE PRODUCT_NUM=#{productNum}
	</update>

	<insert id="buyProduct">
		INSERT INTO PRODUCT_ORDER
			VALUES(ORDER_NUM_SEQ.NEXTVAL, #{productNum}, #{quantity}, #{id}, SYSDATE, #{totalPrice}, 0)
	</insert>

	<select id="readOrder" resultType="com.mall.petshop.product.ProductOrderDTO">
		SELECT *
			FROM (SELECT * FROM PRODUCT_ORDER
				WHERE ID=#{id} AND PRODUCT_NUM=#{productNum} AND STATUS=0
				ORDER BY ORDER_NUM DESC)
			WHERE ROWNUM=1
	</select>

	<insert id="addCart">
		INSERT INTO CART
			VALUES(CART_NUM_SEQ.NEXTVAL, #{productNum}, #{quantity}, #{id})
	</insert>

	<select id="showCartList" resultMap="cartDTO">
		SELECT A.*, B.NAME, B.PRICE, B.THUMBNAIL
			FROM CART A, PRODUCT B
			WHERE A.PRODUCT_NUM=B.PRODUCT_NUM
			AND ID=#{id}
			ORDER BY CART_NUM DESC
	</select>

	<delete id="deleteCart">
		DELETE CART
			WHERE CART_NUM=#{cartNum}
	</delete>

	<select id="showLikeList" resultMap="likeIt">
		SELECT A.*, B.NAME, B.PRICE, B.THUMBNAIL
			FROM LIKEIT A, PRODUCT B
			WHERE A.PRODUCT_NUM=B.PRODUCT_NUM AND ID=#{id}
	</select>

	<delete id="deleteLike">
		DELETE LIKEIT
			WHERE PRODUCT_NUM=#{productNum} AND ID=#{id}
	</delete>

	<delete id="resetCart">
		DELETE CART
			WHERE ID=#{id}
	</delete>

</mapper>